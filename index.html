<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة تحكم بحوث الترابية</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f4f7f6; margin: 0; direction: rtl; }
        .container { width: 94%; max-width: 750px; margin: 20px auto; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; padding-bottom: 30px; }
        .header { background: #8b5b29; padding: 25px; text-align: center; color: white; position: relative; }
        .header a { position: absolute; right: 15px; top: 15px; color: white; background: rgba(0,0,0,0.2); padding: 8px 15px; border-radius: 20px; text-decoration: none; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.3); }
        .main-btn { background: #27ae60; color: white; border: none; padding: 18px; width: 90%; display: block; margin: 20px auto; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .section-box { border: 1px solid #e0e0e0; margin: 15px; border-radius: 12px; background: #fff; overflow: hidden; }
        .section-header { background: #fdf5eb; padding: 12px; border-bottom: 2px solid #8b5b29; font-weight: bold; color: #8b5b29; display: flex; justify-content: space-between; align-items: center; }
        .edit-cat-btn { background: #8b5b29; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
        .item { padding: 15px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; }
        .item-top { display: flex; justify-content: space-between; align-items: center; }
        .btn-group { display: flex; gap: 5px; }
        .edit-btn { color: #2980b9; border: 1px solid #2980b9; background: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; }
        .del-btn { color: #e74c3c; border: 1px solid #e74c3c; background: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 92%; max-width: 450px; margin: 40px auto; padding: 25px; border-radius: 15px; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="user.html">صفحة المستخدم</a>
        <h2 style="margin:0; font-size: 1.2rem;">لوحة التحكم الترابية</h2>
    </div>
    <button class="main-btn" onclick="openAddModal()"> إضافة بحث </button>
    <div id="list">
        <p style="text-align:center; padding:20px; color:#999;">جارِ جلب البيانات من قاعدة البيانات...</p>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="margin-top:0; color:#8b5b29;">إضافة بحث</h3>
        <input type="text" id="cIn" placeholder="عنوان القسم" enterkeyhint="next">
        <input type="text" id="tIn" placeholder="عنوان البحث" enterkeyhint="next">
        <textarea id="txtIn" rows="6" placeholder="اكتب نص البحث هنا..." enterkeyhint="done"></textarea>
        <div style="margin:10px 0; font-size:0.9rem;">لون الكارت: <input type="color" id="colIn" value="#ffffff" style="width:50px; height:30px; padding:0; vertical-align:middle;"></div>
        <input type="hidden" id="editDocId">
        <button id="saveBtn" onclick="saveData()" style="width:100%; padding:15px; background:#8b5b29; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:1.1rem;">حفظ ونشر</button>
        <button onclick="closeModal()" style="width:100%; padding:10px; margin-top:10px; background:none; border:none; color:#999;">إلغاء</button>
    </div>
</div>
<script>
    // 1. إعدادات Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyA3Qp8zzy6FIs1g5ed0HXBkd9FykxGvGR8",
        authDomain: "alturbya.firebaseapp.com",
        projectId: "alturbya",
        storageBucket: "alturbya.firebasestorage.app",
        messagingSenderId: "481479317412",
        appId: "1:481479317412:web:8f070dbc4c87ba5aa59331"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. ميزة إغلاق لوحة المفاتيح عند الضغط خارجاً (للآيفون)
    document.addEventListener('touchstart', function(e) {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'BUTTON') {
            document.activeElement.blur();
        }
    }, false);

    // 3. وظائف التحكم
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function openAddModal() {
        document.getElementById('modalTitle').innerText = "إضافة بحث جديد";
        document.getElementById('cIn').value = '';
        document.getElementById('tIn').value = '';
        document.getElementById('txtIn').value = '';
        document.getElementById('editDocId').value = ""; 
        document.getElementById('modal').style.display = 'block';
    }

    async function saveData() {
        const cat = document.getElementById('cIn').value.trim();
        const title = document.getElementById('tIn').value.trim();
        const text = document.getElementById('txtIn').value.trim();
        const color = document.getElementById('colIn').value;
        const docId = document.getElementById('editDocId').value;

        if (!cat  !title  !text) return alert("❌ أكمل جميع البيانات!");

        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerText = "جارِ الحفظ...";

        const payload = {
            category: cat,
            t: title,
            x: text,
            color: color,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (docId) {
                await db.collection("researches").doc(docId).update(payload);
            } else {
                await db.collection("researches").add(payload);
            }
            closeModal();
        } catch (e) {
            alert("خطأ في الحفظ: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "حفظ ونشر";
        }
    }

    async function del(id) {
        if (confirm("سيتم حذف البحث نهائياً من قاعدة البيانات، هل أنت متأكد؟")) {
            await db.collection("researches").doc(id).delete();
        }
    }

    // جلب البيانات وعرضها
    db.collection("researches").onSnapshot(snapshot => {
        const listDiv = document.getElementById('list');
        listDiv.innerHTML = '';
        let groups = {};

        snapshot.forEach(doc => {
            const data = doc.data();
            if (!groups[data.category]) groups[data.category] = [];
            groups[data.category].push({ id: doc.id, ...data });
        });

        for (let catName in groups) {
            let sectionHtml = `
            <div class="section-box">
                <div class="section-header">
                    <span> ${catName}</span>
                    <button class="edit-cat-btn" onclick="renameCat('${catName}')">تغيير الاسم</button>
                </div>`;
            
            groups[catName].forEach(item => {
                sectionHtml += `
                <div class="item">
                    <div class="item-top">
                        <b>${item.t}</b>
                        <div class="btn-group">
                            <button class="edit-btn" onclick="prepEdit('${item.id}')">تعديل</button>
                            <button class="del-btn" onclick="del('${item.id}')">حذف</button>
                        </div>
                    </div>
                    <div id="data-${item.id}" style="display:none;" 
                         data-cat="${item.category}" 
                         data-title="${item.t}"data-color="${item.color}">${item.x}</div>
                </div>`;
            });
            listDiv.innerHTML += sectionHtml + </div>;
        }
        if(snapshot.empty) listDiv.innerHTML = '<p style="text-align:center; padding:20px;">لا توجد بيانات حالياً</p>';
    });

    function prepEdit(id) {
        const storage = document.getElementById('data-' + id);
        document.getElementById('modalTitle').innerText = "تعديل البحث";
        document.getElementById('cIn').value = storage.getAttribute('data-cat');
        document.getElementById('tIn').value = storage.getAttribute('data-title');
        document.getElementById('txtIn').value = storage.innerText;
        document.getElementById('colIn').value = storage.getAttribute('data-color') || "#ffffff";
        document.getElementById('editDocId').value = id;
        document.getElementById('modal').style.display = 'block';
    }

    async function renameCat(oldName) {
        const newName = prompt("الاسم الجديد للقسم:", oldName);
        if (newName && newName !== oldName) {
            const batch = db.batch();
            const snap = await db.collection("researches").where("category", "==", oldName).get();
            snap.forEach(doc => batch.update(doc.ref, { category: newName }));
            await batch.commit();
            alert("تم التحديث بنجاح");
        }
    }
</script>
</body>
</html>

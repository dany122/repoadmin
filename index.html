<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø© | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root[data-theme="light"] { --bg-admin: #fcfcfc; --card-admin: #ffffff; --text-admin: #1e293b; --green: #16a34a; --border: #f1f5f9; }
        :root[data-theme="dark"] { --bg-admin: #0f172a; --card-admin: #1e293b; --text-admin: #f1f5f9; --green: #22c55e; --border: #334155; }
        :root[data-theme="gray"] { --bg-admin: #374151; --card-admin: #4b5563; --text-admin: #f9fafb; --green: #d1d5db; --border: #6b7280; }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-admin); 
            color: var(--text-admin); 
            transition: background-color 0.4s ease, color 0.4s ease; 
        }

        input, textarea, select {
            background-color: var(--bg-admin) !important;
            color: var(--text-admin) !important;
            border: 1px solid var(--border) !important;
        }
        input::placeholder, textarea::placeholder {
            color: var(--text-admin);
            opacity: 0.5;
        }

        .theme-btn-icon { 
            display: inline-block; 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .theme-btn-active .theme-btn-icon { 
            transform: scale(1.2) rotate(360deg); 
        }

        .item-card { background: var(--card-admin); border: 1px solid var(--border); border-radius: 1.5rem; transition: 0.3s; position: relative; overflow: hidden; height: 160px; }
        .item-card.selected { border: 2px solid var(--green); transform: scale(0.98); }
        .card-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.1; z-index: 0; }
        .card-content { position: relative; z-index: 10; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .edit-btn-float { transform: scale(0); transition: 0.2s; visibility: hidden; }
        .selected .edit-btn-float { transform: scale(1); visibility: visible; }
        .modal-blur { backdrop-filter: blur(8px); background: rgba(0,0,0,0.4); }
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body data-theme="light" class="pb-20">

    <header class="bg-[var(--card-admin)] sticky top-0 z-[100] p-4 border-b border-[var(--border)] flex justify-between items-center backdrop-blur-md">
        <div onclick="goHome()" class="flex items-center gap-2 cursor-pointer">
            <div class="w-9 h-9 bg-green-600 rounded-xl flex items-center justify-center text-white text-[10px] font-black">Admin</div>
            <h1 class="font-bold text-sm">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
        </div>
        <div class="flex gap-2 items-center">
            <button onclick="cycleTheme(this)" id="theme-btn" class="w-10 h-10 flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-full outline-none">
                <span class="theme-btn-icon text-lg">â˜€ï¸</span>
            </button>
            <button onclick="prepareNewItem('folder')" class="bg-slate-100 text-slate-600 px-3 py-2 rounded-xl text-[10px] font-bold">ğŸ“ Ù…Ø¬Ù„Ø¯</button>
            <button onclick="prepareNewItem('research')" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black">+ Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </header>

    <main class="p-4 max-w-5xl mx-auto">
        <nav id="breadcrumbs" class="flex items-center gap-2 mb-6 text-[10px] font-bold opacity-50"></nav>
        <div id="explorer-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
        <div id="loader" class="hidden flex justify-center mt-20"><div class="animate-spin w-6 h-6 border-2 border-green-600 border-t-transparent rounded-full"></div></div>
    </main>

    <div id="folder-modal" class="hidden fixed inset-0 z-[110] modal-blur flex items-center justify-center p-6">
        <div class="bg-[var(--card-admin)] w-full max-w-sm rounded-[2rem] p-8 shadow-2xl border border-[var(--border)]">
            <input type="text" id="folder-name" class="w-full p-4 rounded-xl outline-none font-bold text-center mb-4" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯">
            <input type="text" id="folder-bg-link" class="w-full p-3 rounded-xl outline-none text-[10px] text-center mb-6" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØºÙ„Ø§Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <div class="flex gap-2">
                <button onclick="saveFolder()" class="flex-[2] bg-green-600 text-white py-4 rounded-xl font-black text-xs">Ø­ÙØ¸</button>
                <button onclick="closeModals()" class="flex-1 bg-slate-100 text-slate-400 py-4 rounded-xl font-bold text-xs">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
            <button onclick="deleteItem()" class="w-full text-red-500 font-bold mt-4 text-[10px]">Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù„Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
        </div>
    </div>

    <div id="editor-overlay" class="hidden fixed inset-0 z-[120] bg-[var(--bg-admin)] p-6 overflow-y-auto">
        <div class="max-w-3xl mx-auto space-y-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-[var(--text-admin)]">ğŸ“ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¨Ø­Ø«</h3>
                <button onclick="closeModals()" class="text-2xl text-[var(--text-admin)]">âœ•</button>
            </div>
            <input type="text" id="edit-title" class="w-full p-4 rounded-xl outline-none font-bold" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
            <input type="text" id="research-bg-link" class="w-full p-4 rounded-xl outline-none text-xs" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù">
            <select id="move-folder-select" class="w-full p-4 rounded-xl outline-none font-bold text-xs"></select>
            
            <div class="bg-slate-900 p-4 rounded-xl flex gap-2 border border-slate-700">
                <input type="text" id="inline-img-url" class="flex-1 bg-white/10 p-2 rounded text-white text-xs border-none" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù„Ù„Ù…Ø­ØªÙˆÙ‰">
                <button onclick="insertImageUrl()" class="bg-green-600 text-white px-4 py-2 rounded font-bold text-xs">Ø¥Ø¯Ø±Ø§Ø¬</button>
            </div>
            
            <textarea id="edit-content" rows="12" class="w-full p-6 rounded-2xl outline-none text-sm leading-relaxed" placeholder="Ø§Ù„Ù…Ø­ØªÙˆÙ‰..."></textarea>
            <button onclick="handleSaveResearch()" class="w-full bg-green-600 text-white py-5 rounded-2xl font-black shadow-lg">Ø­ÙØ¸ ÙˆÙ†Ø´Ø±</button>
            <button onclick="deleteItem()" class="w-full text-red-500 font-bold py-2">Ø­Ø°Ù Ø§Ù„Ø¨Ø­Ø«</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyA3Qp8zzy6FIs1g5ed0HXBkd9FykxGvGR8", authDomain: "alturbya.firebaseapp.com", projectId: "alturbya", appId: "1:481479317412:web:8f070dbc4c87ba5aa59331" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let pathHistory = [{id: 'root', name: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}], lastClickedId = null;

        function cycleTheme(btn) {
            const themes = ['light', 'dark', 'gray'];
            const icons = { light: 'â˜€ï¸', dark: 'ğŸŒ™', gray: 'ğŸ”˜' };
            let cur = document.documentElement.getAttribute('data-theme') || 'light';
            let next = themes[(themes.indexOf(cur) + 1) % themes.length];
            if(btn) { btn.classList.add('theme-btn-active'); setTimeout(() => btn.classList.remove('theme-btn-active'), 400); }
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('admin-theme', next);
            const iconSpan = document.querySelector('.theme-btn-icon');
            if(iconSpan) iconSpan.innerText = icons[next];
        }

        function prepareNewItem(type) {
            window.currentEditId = null;
            if(type === 'folder') {
                document.getElementById('folder-name').value = "";
                document.getElementById('folder-bg-link').value = "";
                document.getElementById('folder-modal').classList.remove('hidden');
            } else {
                document.getElementById('edit-title').value = "";
                document.getElementById('edit-content').value = "";
                document.getElementById('research-bg-link').value = "";
                document.getElementById('move-folder-select').value = pathHistory[pathHistory.length-1].id;
                document.getElementById('editor-overlay').classList.remove('hidden');
            }
        }

        function fetchContent() {
            document.getElementById('loader').classList.remove('hidden');
            const current = pathHistory[pathHistory.length - 1];
            db.collection("research_tree").where("parentId", "==", current.id).onSnapshot(snap => {
                const items = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderExplorer(items);
                document.getElementById('loader').classList.add('hidden');
            });
            db.collection("research_tree").where("type", "==", "folder").get().then(snap => {
                const folders = snap.docs.map(doc => ({id: doc.id, name: doc.data().name}));
                document.getElementById('move-folder-select').innerHTML = `<option value="root">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>` + folders.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            });
            renderBreadcrumbs();
        }

        function renderExplorer(items) {
            const grid = document.getElementById('explorer-grid');
            grid.innerHTML = "";
            items.sort((a,b) => (a.type === 'folder' ? -1 : 1)).forEach(item => {
                const card = document.createElement('div');
                card.className = "item-card";
                card.innerHTML = `
                    ${item.bgImage ? `<img src="${item.bgImage}" class="card-bg">` : ''}
                    <div class="card-content">
                        <div class="text-3xl mb-2">${item.type==='folder'?'ğŸ“š':'ğŸ“–'}</div>
                        <span class="text-[11px] font-bold px-4 text-center">${item.name || item.t}</span>
                        <button onclick="event.stopPropagation(); editItem('${item.id}')" class="edit-btn-float mt-2 bg-black text-white px-3 py-1 rounded text-[9px]">ØªØ¹Ø¯ÙŠÙ„</button>
                    </div>`;
                card.onclick = () => {
                    if(lastClickedId === item.id) {
                        if(item.type==='folder') { pathHistory.push({id:item.id, name:item.name}); fetchContent(); }
                        else editItem(item.id);
                        lastClickedId = null;
                    } else {
                        document.querySelectorAll('.item-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        lastClickedId = item.id;
                    }
                };
                grid.appendChild(card);
            });
        }

        async function editItem(id) {
            const doc = await db.collection("research_tree").doc(id).get();
            const data = doc.data();
            window.currentEditId = id;
            if(data.type === 'folder') {
                document.getElementById('folder-modal').classList.remove('hidden');
                document.getElementById('folder-name').value = data.name;
                document.getElementById('folder-bg-link').value = data.bgImage || "";
            } else {
                document.getElementById('editor-overlay').classList.remove('hidden');
                document.getElementById('edit-title').value = data.t;
                document.getElementById('edit-content').value = data.x;
                document.getElementById('research-bg-link').value = data.bgImage || "";
                document.getElementById('move-folder-select').value = data.parentId;
            }
        }

        async function handleSaveResearch() {
            const parentId = document.getElementById('move-folder-select').value;
            const data = {
                t: document.getElementById('edit-title').value,
                x: document.getElementById('edit-content').value,
                bgImage: document.getElementById('research-bg-link').value,
                parentId: parentId,
                type: 'research', updatedAt: Date.now()
            };
            if(window.currentEditId) await db.collection("research_tree").doc(window.currentEditId).update(data);
            else await db.collection("research_tree").add(data);
            closeModals();
        }

        async function saveFolder() {
            const data = { 
                name: document.getElementById('folder-name').value, 
                bgImage: document.getElementById('folder-bg-link').value,
                type: 'folder', parentId: pathHistory[pathHistory.length-1].id 
            };
            if(window.currentEditId) await db.collection("research_tree").doc(window.currentEditId).update(data);
            else await db.collection("research_tree").add(data);
            closeModals();
        }

        async function deleteItem() {
            if(!window.currentEditId) return;
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                await db.collection("research_tree").doc(window.currentEditId).delete();
                closeModals();
            }
        }

        function insertImageUrl() {
            const url = document.getElementById('inline-img-url').value;
            if(url) document.getElementById('edit-content').value += `\n<img src="${url}">\n`;
        }

        function closeModals() { 
            document.querySelectorAll('#folder-modal, #editor-overlay').forEach(m => m.classList.add('hidden'));
            window.currentEditId = null;
        }
        
        function renderBreadcrumbs() {
            document.getElementById('breadcrumbs').innerHTML = pathHistory.map((h,i) => `<span onclick="pathHistory=pathHistory.slice(0,${i+1});fetchContent()">${h.name}</span>`).join(' / ');
        }
        
        function goHome() { pathHistory = [{id:'root', name:'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}]; fetchContent(); }

        window.onload = () => {
            const saved = localStorage.getItem('admin-theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            const iconSpan = document.querySelector('.theme-btn-icon');
            if(iconSpan) iconSpan.innerText = (saved === 'light' ? 'â˜€ï¸' : (saved === 'dark' ? 'ğŸŒ™' : 'ğŸ”˜'));
            fetchContent();
        };
    </script>
</body>
</html>

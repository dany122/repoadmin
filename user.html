<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªØ±Ø§Ø¨ÙŠØ©</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-page: #f8fafc; --accent-green: #16a34a; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-page); transition: background 0.3s ease; overflow: hidden; }
        
        body.theme-white { --bg-reader: #ffffff; --text-reader: #1e293b; }
        body.theme-dark { --bg-reader: #121212; --text-reader: #e2e8f0; }
        body.theme-sepia { --bg-reader: #f4ecd8; --text-reader: #5b4636; }

        #reader-view { background-color: var(--bg-reader); color: var(--text-reader); }
        
        .highlight { 
            background: linear-gradient(to top, rgba(255, 193, 7, 0.4) 100%, transparent 0);
            display: inline;
            border-radius: 2px;
            padding: 0;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
            font-weight: bold;
        }

        #search-overlay, #internal-search-overlay {
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            transform: translateY(-100%);
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }
        #search-overlay.active, #internal-search-overlay.active { transform: translateY(0); }

        .book-content { font-family: 'Amiri', serif; line-height: 2.3; font-size: 1.55rem; text-align: justify; }
        .filter-btn.active { background: var(--accent-green); color: white; }

        .res-card, .internal-res-card {
            background: white; padding: 16px; border-radius: 20px;
            border-right: 4px solid #fbbf24; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            margin-bottom: 12px; cursor: pointer; transition: 0.2s; color: #1e293b;
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù„Ù„Ø­Ø§ÙˆÙŠØ§Øª */
        .custom-scroll {
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .custom-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="theme-white h-screen flex flex-col">

    <div id="main-view" class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="p-6 flex justify-between items-center shrink-0">
            <div>
                <h1 class="text-2xl font-black text-slate-900">Ø§Ù„Ù…ÙƒØªØ¨Ø©</h1>
                <p class="text-[10px] text-slate-400 font-bold border-r-2 border-green-600 pr-2 mt-1 uppercase">Ø§Ù„ØªØ±Ø§Ø¨ÙŠØ© </p>
            </div>
            <button onclick="openGlobalSearch()" class="w-12 h-12 bg-white rounded-2xl shadow-sm flex items-center justify-center border border-slate-100">ğŸ”</button>
        </header>

        <div class="flex-1 custom-scroll px-4 pb-28">
            <div id="categories-container" class="grid grid-cols-2 gap-4"></div>
            
            <div id="research-list-container" class="hidden">
                <div class="sticky top-0 bg-[#f8fafc]/90 backdrop-blur-md py-4 z-10 flex items-center justify-between mb-5 px-2">
                    <button onclick="showCategories()" class="text-green-600 text-xs font-black bg-green-50 px-4 py-2 rounded-xl">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
                    <span id="current-cat-name" class="text-[10px] font-black text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full uppercase"></span>
                </div>
                <div id="research-list" class="space-y-3 pb-10"></div>
            </div>
        </div>
    </div>

    <div id="search-overlay" class="fixed inset-0 z-[100] flex flex-col">
        <div class="p-6 border-b border-slate-100 flex items-center gap-4 shrink-0">
            <button onclick="closeGlobalSearch()" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-full">âœ•</button>
            <input type="text" id="global-search-input" oninput="handleGlobalSearch()" placeholder="Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« ..." class="flex-1 p-4 bg-slate-100 rounded-2xl border-none outline-none font-bold">
        </div>
        <div class="px-6 py-4 flex gap-3 overflow-x-auto no-scrollbar shrink-0">
            <button onclick="setSearchFilter('cats')" class="px-5 py-2 rounded-xl text-[11px] font-black filter-btn active" id="f-cats">Ø§Ù„Ù‚Ø³Ù…</button>
            <button onclick="setSearchFilter('titles')" class="px-5 py-2 rounded-xl text-[11px] font-black filter-btn" id="f-titles">Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
            <button onclick="setSearchFilter('content')" class="px-5 py-2 rounded-xl text-[11px] font-black filter-btn" id="f-content">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</button>
        </div>
        <div id="global-results" class="flex-1 custom-scroll px-6 pb-10"></div>
    </div>

    <div id="internal-search-overlay" class="fixed inset-0 z-[130] flex flex-col">
        <div class="p-6 border-b border-slate-100 flex items-center gap-4 shrink-0">
            <button onclick="closeInternalSearch()" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-full text-slate-400">âœ•</button>
            <input type="text" id="reader-internal-input" oninput="internalSearchInContent()" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª..." class="flex-1 p-4 bg-slate-100 rounded-2xl border-none outline-none font-bold">
        </div>
        <div id="internal-results" class="flex-1 custom-scroll px-6 py-6"></div>
    </div>

    <div id="reader-view" class="hidden fixed inset-0 z-[110] flex flex-col">
        <header class="h-16 flex items-center px-4 border-b border-black/5 shrink-0">
            <button onclick="closeReader()" class="w-10 h-10 flex items-center justify-center rounded-xl bg-black/5">âœ•</button>
            <div class="flex-1 px-4 text-center truncate font-bold text-[10px] opacity-60 uppercase" id="reader-title"></div>
            <div class="flex gap-2 items-center">
                <button onclick="openInternalSearch()" class="w-9 h-9 rounded-full bg-black/5 flex items-center justify-center">ğŸ”</button>
                <button onclick="setTheme('white')" class="w-6 h-6 rounded-full bg-white border border-slate-300"></button>
                <button onclick="setTheme('sepia')" class="w-6 h-6 rounded-full bg-[#f4ecd8] border border-amber-300"></button>
                <button onclick="setTheme('dark')" class="w-6 h-6 rounded-full bg-slate-900 border border-slate-700"></button>
            </div>
        </header>

        <main id="reader-scroll-area" class="flex-1 custom-scroll px-6 py-10">
            <div id="reader-content" class="book-content max-w-xl mx-auto"></div>
        </main>

        <footer class="h-20 flex items-center justify-center shrink-0">
            <div class="flex items-center gap-10 bg-slate-900 text-white px-8 py-3 rounded-full shadow-2xl">
                <button onclick="changePage(-1)">â—€</button>
                <span id="page-indicator" class="text-[11px] font-black min-w-[50px] text-center"></span>
                <button onclick="changePage(1)">â–¶</button>
            </div>
        </footer>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA3Qp8zzy6FIs1g5ed0HXBkd9FykxGvGR8",
            authDomain: "alturbya.firebaseapp.com",
            projectId: "alturbya",
            storageBucket: "alturbya.firebasestorage.app",
            appId: "1:481479317412:web:8f070dbc4c87ba5aa59331"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let allResearches = [];
        let currentPages = [];
        let currentPageIndex = 0;
        let searchFilter = 'cats';
        let highlightQuery = "";

        db.collection("researches").onSnapshot(snap => {
            allResearches = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCategories();
        });

        function splitText(t) {
            const size = 1200;
            const chunks = [];
            for (let i = 0; i < (t || "").length; i += size) { chunks.push(t.substring(i, i + size)); }
            return chunks;
        }

        function handleGlobalSearch() {
            const q = document.getElementById('global-search-input').value.trim();
            const resDiv = document.getElementById('global-results');
            highlightQuery = q;
            if(!q) { resDiv.innerHTML = ""; return; }
            let results = [];

            if (searchFilter === 'cats') {
                [...new Set(allResearches.map(r => r.category || "Ø¹Ø§Ù…"))].forEach(cat => {
                    if (cat.includes(q)) results.push({ type: 'category', title: cat });
                });
            }
            if (searchFilter === 'titles') {
                allResearches.forEach(r => {
                    if (r.t.includes(q)) results.push({ ...r, type: 'title', title: r.t, pIdx: 0 });
                });
            }
            if (searchFilter === 'content') {
                allResearches.forEach(r => {
                    const pgs = r.pages || splitText(r.x);
                    pgs.forEach((p, idx) => {
                        if (p.includes(q)) {
                            const start = Math.max(0, p.indexOf(q) - 40);
                            results.push({ ...r, type: 'content', title: r.t, pIdx: idx, snip: "..." + p.substring(start, start + 80).replace(/\n/g, ' ') + "..." });
                        }
                    });
                });
            }
            resDiv.innerHTML = results.map(r => `
                <div onclick="${r.type === 'category' ? `showResearchInCat('${r.title}'); closeGlobalSearch();` : `openReader('${r.id}', ${r.pIdx})`}" 
                     class="res-card ${r.type === 'category' ? 'border-blue-500' : 'border-green-500'}">
                    <h4 class="text-[13px] font-black">${r.title}</h4>
                    ${r.snip ? `<p class="text-[11px] text-slate-500 mt-2 bg-slate-50 p-2 rounded-lg leading-relaxed">${r.snip}</p>` : ''}
                </div>
            `).join('');
        }

        function internalSearchInContent() {
            const q = document.getElementById('reader-internal-input').value.trim();
            const resArea = document.getElementById('internal-results');
            highlightQuery = q;
            if(!q) { resArea.innerHTML = ""; return; }
            let found = [];
            currentPages.forEach((text, index) => {
                if(text.includes(q)) {
                    const start = Math.max(0, text.indexOf(q) - 40);
                    found.push({ page: index, snippet: "..." + text.substring(start, start + 90).replace(/\n/g, ' ') + "..." });
                }
            });
            resArea.innerHTML = found.map(f => `
                <div onclick="goToResultPage(${f.page})" class="internal-res-card">
                    <span class="text-[10px] font-black text-amber-600 block mb-1">Ø§Ù„ØµÙØ­Ø© ${f.page+1}</span>
                    <p class="text-[12px] text-slate-600 font-bold leading-relaxed">${f.snippet}</p>
                </div>
            `).join('') || '<div class="text-center text-slate-300">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
        }

        function goToResultPage(p) { currentPageIndex=p; renderCurrentPage(); closeInternalSearch(); setTimeout(scrollToHighlight, 300); }

        function openReader(id, pIdx = 0) {
            const res = allResearches.find(r => r.id === id);
            currentPages = res.pages || splitText(res.x);
            currentPageIndex = pIdx;
            document.getElementById('reader-title').innerText = res.t;
            document.getElementById('reader-view').classList.remove('hidden');
            closeGlobalSearch();
            renderCurrentPage();
        }

        function renderCurrentPage() {
            let text = currentPages[currentPageIndex];
            
            // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ---
            // ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø£ÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ (Enter) Ø¨ÙˆØ³Ù… <br> Ù„ÙŠØ¸Ù‡Ø± ÙÙŠ HTML
            text = text.replace(/\n/g, '<br>'); 
            
            if (highlightQuery && highlightQuery.length > 1) {
                const escapedQuery = highlightQuery.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&');
                const regex = new RegExp(`(${escapedQuery})`, "g");
                let isFirst = true;
                text = text.replace(regex, (match) => {
                    const idTag = isFirst ? 'id="target-word"' : '';
                    isFirst = false;
                    return `<span ${idTag} class="highlight">${match}</span>`;
                });
            }
            document.getElementById('reader-content').innerHTML = text;
            document.getElementById('page-indicator').innerText = `${currentPageIndex + 1} / ${currentPages.length}`;
            document.getElementById('reader-scroll-area').scrollTop = 0;
            if(highlightQuery) setTimeout(scrollToHighlight, 200);
        }

        function scrollToHighlight() {
            const target = document.getElementById('target-word');
            if (target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            const cats = [...new Set(allResearches.map(r => r.category || "Ø¹Ø§Ù…"))];
            container.innerHTML = cats.map(cat => `
                <div onclick="showResearchInCat('${cat}')" class="bg-white p-6 rounded-3xl flex flex-col items-center gap-3 border border-slate-100 shadow-sm active:scale-95 transition">
                   
                    <span class="font-black text-slate-700 text-[11px] text-center">${cat}</span>
                </div>
            `).join('');
        }

        function showResearchInCat(cat) {
            document.getElementById('categories-container').classList.add('hidden');
            document.getElementById('research-list-container').classList.remove('hidden');
            document.getElementById('current-cat-name').innerText = cat;
            const filtered = allResearches.filter(r => (r.category || "Ø¹Ø§Ù…") === cat);
            document.getElementById('research-list').innerHTML = filtered.map(r => `
                <div onclick="openReader('${r.id}')" class="p-4 bg-white border border-slate-100 rounded-2xl flex justify-between items-center shadow-sm active:scale-95 transition">
                    <span class="text-[12px] font-bold text-slate-700">${r.t}</span>
                    <span class="text-slate-200">ğŸ“–</span>
                </div>
            `).join('');
        }

        function showCategories() { document.getElementById('categories-container').classList.remove('hidden'); document.getElementById('research-list-container').classList.add('hidden'); }
        function setTheme(m) { document.body.className = 'theme-' + m; }
        function openGlobalSearch() { document.getElementById('search-overlay').classList.add('active'); document.getElementById('global-search-input').focus(); }
        function closeGlobalSearch() { document.getElementById('search-overlay').classList.remove('active'); }
        function openInternalSearch() { document.getElementById('internal-search-overlay').classList.add('active'); document.getElementById('reader-internal-input').focus(); }
        function closeInternalSearch() { document.getElementById('internal-search-overlay').classList.remove('active'); }
        function closeReader() { document.getElementById('reader-view').classList.add('hidden'); highlightQuery=""; }
        function changePage(d) { if(currentPageIndex+d >= 0 && currentPageIndex+d < currentPages.length){ currentPageIndex+=d; renderCurrentPage(); } }
        function setSearchFilter(f) { searchFilter = f; document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.id === 'f-'+f)); handleGlobalSearch(); }
    </script>
</body>
                    </html>
